<!DOCTYPE html>
<html>
<head>
    <title>MBTI测试与每日激励</title>
    <style>
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            font-family: Arial, sans-serif;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .question-container {
            margin-bottom: 30px;
        }

        .question-number {
            color: #666;
            margin-bottom: 10px;
        }

        .question-text {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .option-btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background-color: #f5f5f5;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .option-btn:hover {
            background-color: #007AFF;
            color: white;
        }

        .result-container {
            text-align: center;
            padding: 40px 0;
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .nav-btn {
            padding: 10px 20px;
            background-color: #007AFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .quote-container {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .quote-text {
            font-size: 18px;
            font-style: italic;
            color: #333;
            margin-bottom: 10px;
        }

        .mbti-type {
            color: #666;
            margin-bottom: 20px;
        }

        .input-section {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .input-section input {
            width: 200px;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 300px;
            margin: 20px auto;
        }

        .action-btn {
            padding: 15px 20px;
            background-color: #007AFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .action-btn:hover {
            background-color: #0056b3;
        }

        .time-message {
            color: #007AFF;
            font-size: 18px;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .quote-container {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 25px;
            margin-top: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chat-button {
            width: 60px;
            height: 60px;
            border-radius: 30px;
            background-color: #007AFF;
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: transform 0.2s;
            user-select: none;
        }

        .chat-button:hover {
            transform: scale(1.1);
        }

        .chat-button:active {
            transform: scale(0.95);
        }

        .chat-container {
            position: absolute;
            bottom: 70px;
            right: 0;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            overflow: hidden;
            transition: opacity 0.3s, transform 0.3s;
        }

        .chat-header {
            padding: 15px;
            background: #007AFF;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 10px;
            max-width: 80%;
        }

        .user-message {
            margin-left: auto;
            background: #007AFF;
            color: white;
            padding: 8px 12px;
            border-radius: 15px 15px 0 15px;
        }

        .bot-message {
            margin-right: auto;
            background: #f0f0f0;
            padding: 8px 12px;
            border-radius: 15px 15px 15px 0;
        }

        .chat-input-container {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }

        .chat-actions {
            display: flex;
            gap: 10px;
        }

        .chat-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 18px;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-action-btn:hover {
            background: #e0e0e0;
        }

        /* 确保 chat-wrapper 始终显示在最上层 */
        #chat-wrapper {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            pointer-events: auto;
        }

        .loading {
            position: relative;
            min-width: 30px;
            min-height: 20px;
        }

        .loading::after {
            content: '...';
            position: absolute;
            animation: loading 1s infinite;
        }

        @keyframes loading {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }

        .recording {
            background-color: #ff4444 !important;
            color: white !important;
        }

        .message img {
            max-width: 200px;
            border-radius: 8px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <!-- 聊天组件 -->
    <div id="chat-wrapper">
        <button class="chat-button" onclick="toggleChat()">💬</button>
        <div class="chat-container" id="chatContainer">
            <div class="chat-header">
                <span id="aiAssistantName">AI 助手</span>
                <button onclick="toggleChat()" style="background: none; border: none; color: white; cursor: pointer;">✕</button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <!-- 消息将在这里动态添加 -->
            </div>
            <div class="chat-input-container">
                <div class="chat-actions">
                    <button class="chat-action-btn" onclick="toggleVoiceInput()" title="语音输入">🎤</button>
                    <button class="chat-action-btn" onclick="uploadFile()" title="上传文件">📎</button>
                    <button class="chat-action-btn" onclick="uploadImage()" title="上传图片">🖼️</button>
                </div>
                <input type="text" class="chat-input" id="chatInput" placeholder="输入消息..." onkeypress="handleKeyPress(event)">
                <button class="chat-action-btn" onclick="sendMessage()" title="发送">➤</button>
            </div>
        </div>
    </div>

    <!-- 添加隐藏的文件上传输入 -->
    <input type="file" id="fileInput" style="display: none" onchange="handleFileUpload(event)">
    <input type="file" id="imageInput" accept="image/*" style="display: none" onchange="handleImageUpload(event)">

    <div class="container">
        <div class="header">
            <h1>MBTI测试与每日激励</h1>
        </div>
        <div id="main-container">
            <div class="action-buttons">
                <button class="action-btn" onclick="showInputSection()">已知MBTI类型</button>
                <button class="action-btn" onclick="showTestSection()">开始MBTI测试</button>
            </div>
        </div>
    </div>

    <script>
        const questions = [
            {
                id: 1,
                text: "在社交场合中，你通常会：",
                options: [
                    { value: "E", text: "主动与他人交谈，感到能量充沛" },
                    { value: "I", text: "倾向于安静观察，觉得社交消耗能量" }
                ]
            },
            {
                id: 2,
                text: "在获取信息时，你更倾向于：",
                options: [
                    { value: "S", text: "关注具体的细节和事实" },
                    { value: "N", text: "关注概念和可能性" }
                ]
            },
            {
                id: 3,
                text: "做决定时，你通常会：",
                options: [
                    { value: "T", text: "依据逻辑和客观分析" },
                    { value: "F", text: "考虑他人感受和价值观" }
                ]
            },
            {
                id: 4,
                text: "在日常生活中，你更喜欢：",
                options: [
                    { value: "J", text: "按计划行事，喜欢确定性" },
                    { value: "P", text: "保持灵活，随机应变" }
                ]
            }
        ];

        let currentQuestionIndex = 0;
        let answers = new Array(questions.length).fill('');

        function showQuestion() {
            const question = questions[currentQuestionIndex];
            const container = document.getElementById('main-container');

            if (currentQuestionIndex >= questions.length) {
                showResult();
                return;
            }

            container.innerHTML = `
                <div class="question-container">
                    <div class="question-number">问题 ${currentQuestionIndex + 1}/${questions.length}</div>
                    <div class="question-text">${question.text}</div>
                    <div class="options-container">
                        ${question.options.map(option => `
                            <button class="option-btn" onclick="selectAnswer('${option.value}')">
                                ${option.text}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function selectAnswer(value) {
            answers[currentQuestionIndex] = value;
            currentQuestionIndex++;
            showQuestion();
        }

        function calculateResult() {
            let mbtiResult = '';
            
            // E/I
            const eCount = answers.filter(a => a === 'E').length;
            mbtiResult += eCount > answers.length/8 ? 'E' : 'I';
            
            // S/N
            const sCount = answers.filter(a => a === 'S').length;
            mbtiResult += sCount > answers.length/8 ? 'S' : 'N';
            
            // T/F
            const tCount = answers.filter(a => a === 'T').length;
            mbtiResult += tCount > answers.length/8 ? 'T' : 'F';
            
            // J/P
            const jCount = answers.filter(a => a === 'J').length;
            mbtiResult += jCount > answers.length/8 ? 'J' : 'P';

            return mbtiResult;
        }

        const motivationalQuotes = {
            INTJ: {
                morning: [
                    "新的一天，用战略性思维规划你的目标。",
                    "早安，让我们专注于最重要的任务。",
                    "清晨是思考和计划的最佳时刻。"
                ],
                noon: [
                    "停下来审视你的进度，调整接下来的计划。",
                    "午休时刻，让大脑短暂放松，然后继续前进。",
                    "记得在工作间隙留出时间思考。"
                ],
                evening: [
                    "回顾今天的收获，为明天做好准备。",
                    "感谢今天的每个决定，它们都在塑造更好的你。",
                    "晚上是总结经验的好时机。"
                ]
            },
            INTP: {
                morning: [
                    "早安，让好奇心引领新的一天。",
                    "用创新的思维开启今天的探索。",
                    "新的一天，新的发现等着你。"
                ],
                noon: [
                    "午休时刻，让思维沉淀一下。",
                    "稍作休息，让创意继续发酵。",
                    "给自己一点时间整理上午的想法。"
                ],
                evening: [
                    "回顾今天的思考收获。",
                    "感谢今天遇到的每个有趣问题。",
                    "总结今天的发现，期待明天的探索。"
                ]
            },
            ENTJ: {
                morning: [
                    "早安，领导者！新的一天等待你的指挥。",
                    "制定今天的目标，带领团队前进。",
                    "清晨是规划和部署的最佳时机。"
                ],
                noon: [
                    "检视上午的进度，调整下午的策略。",
                    "适当休息，保持最佳决策状态。",
                    "利用午休时间思考重要决策。"
                ],
                evening: [
                    "回顾今天的成果，规划明天的目标。",
                    "感谢团队的付出，为明天做好准备。",
                    "总结今天的经验，明天会更好。"
                ]
            },
            ENTP: {
                morning: [
                    "早安，创新者！新的想法在等着你。",
                    "让我们用新视角开启今天。",
                    "早晨是头脑风暴的最佳时刻。"
                ],
                noon: [
                    "暂停思考，让创意沉淀。",
                    "换个角度看待上午的发现。",
                    "休息片刻，准备下午的创新。"
                ],
                evening: [
                    "整理今天的灵感，期待明天的可能。",
                    "感谢今天遇到的每个挑战。",
                    "让我们期待明天的新发现。"
                ]
            },
            ENFJ: {
                morning: [
                    "早安，激励者！准备去温暖他人的心。",
                    "新的一天，新的机会去帮助他人。",
                    "用你的热情点亮这个早晨。"
                ],
                noon: [
                    "休息片刻，继续传递温暖。",
                    "调整状态，保持积极能量。",
                    "午休时刻，关心一下自己。"
                ],
                evening: [
                    "回顾今天帮助过的人们。",
                    "感恩今天的每次互动。",
                    "为明天的温暖相遇做准备。"
                ]
            },
            ENFP: {
                morning: [
                    "早安，梦想家！新的冒险等着你。",
                    "让我们用热情拥抱这一天。",
                    "今天会有令人兴奋的发现。"
                ],
                noon: [
                    "享受午休时光，补充能量。",
                    "放松心情，保持创造力。",
                    "准备下午的精彩时刻。"
                ],
                evening: [
                    "感谢今天的每个精彩瞬间。",
                    "回顾今天的快乐时光。",
                    "带着期待入睡，明天继续冒险。"
                ]
            },
            ESTJ: {
                morning: [
                    "早安，执行者！开始高效的一天。",
                    "按计划行事，确保目标达成。",
                    "新的一天，新的任务等待完成。"
                ],
                noon: [
                    "检查上午的完成度，规划下午。",
                    "合理休息，保持执行力。",
                    "准备下午的工作安排。"
                ],
                evening: [
                    "回顾今天的完成情况。",
                    "为明天做好准备和计划。",
                    "总结经验，期待更有效率的明天。"
                ]
            },
            ESFJ: {
                morning: [
                    "早安，关怀者！准备传递温暖。",
                    "新的一天，新的机会关心他人。",
                    "用善意开启美好的一天。"
                ],
                noon: [
                    "照顾好自己，继续关爱他人。",
                    "享受午休，补充关怀能量。",
                    "准备下午的暖心时刻。"
                ],
                evening: [
                    "感恩今天帮助过的每个人。",
                    "回顾今天的温暖时刻。",
                    "带着爱心入睡，明天继续付出。"
                ]
            },
            ESTP: {
                morning: [
                    "早安，冒险家！新的挑战等着你。",
                    "准备好迎接刺激的一天。",
                    "今天将充满行动和机遇。"
                ],
                noon: [
                    "补充能量，准备下午的挑战。",
                    "短暂休息，保持敏锐直觉。",
                    "调整状态，迎接新的机会。"
                ],
                evening: [
                    "回顾今天的精彩时刻。",
                    "感谢今天的每次冒险。",
                    "期待明天的新挑战。"
                ]
            },
            ESFP: {
                morning: [
                    "早安，表演者！让我们开始精彩的一天。",
                    "用欢乐点亮这个早晨。",
                    "准备好享受今天的快乐时光。"
                ],
                noon: [
                    "享受午休的欢乐时光。",
                    "补充能量，继续散播快乐。",
                    "准备下午的精彩表现。"
                ],
                evening: [
                    "感谢今天的欢乐时光。",
                    "回顾今天带给他人的微笑。",
                    "带着快乐入睡，期待明天的精彩。"
                ]
            },
            ISTJ: {
                morning: [
                    "早安，守护者！新的一天需要你的专注。",
                    "按部就班，稳步完成今天的任务。",
                    "用可靠的态度开启充实的一天。"
                ],
                noon: [
                    "检查上午的工作成果。",
                    "适度休息，保持最佳状态。",
                    "为下午的工作做好准备。"
                ],
                evening: [
                    "回顾今天的完成情况。",
                    "感谢自己的坚持和付出。",
                    "整理思绪，准备明天的计划。"
                ]
            },
            ISFJ: {
                morning: [
                    "早安，守护者！准备去关爱他人。",
                    "用细心和耐心开启新的一天。",
                    "今天也要继续温暖他人。"
                ],
                noon: [
                    "照顾他人的同时也要照顾自己。",
                    "享受片刻宁静，补充能量。",
                    "准备下午的关怀时光。"
                ],
                evening: [
                    "感恩今天付出的每一刻。",
                    "回顾今天帮助过的人。",
                    "带着温暖的心入睡。"
                ]
            },
            ISTP: {
                morning: [
                    "早安，匠人！新的挑战等待解决。",
                    "用灵活的思维迎接新的一天。",
                    "保持专注，享受动手的过程。"
                ],
                noon: [
                    "检查上午的进展。",
                    "调整状态，保持敏锐。",
                    "准备下午的实践时光。"
                ],
                evening: [
                    "回顾今天解决的问题。",
                    "感谢今天的每次尝试。",
                    "整理工具，期待明天的挑战。"
                ]
            },
            ISFP: {
                morning: [
                    "早安，艺术家！让灵感指引新的一天。",
                    "用独特的视角感受这个世界。",
                    "保持真我，享受创作的过程。"
                ],
                noon: [
                    "享受午后的艺术时光。",
                    "放松心情，让灵感继续流动。",
                    "准备下午的创意时刻。"
                ],
                evening: [
                    "感受今天的美好瞬间。",
                    "回顾今天的艺术灵感。",
                    "带着创意入睡，期待明天的灵感。"
                ]
            },
            INFJ: {
                morning: [
                    "早安，理想主义者！新的一天等待你的洞察。",
                    "用独特的视角感受这个世界。",
                    "让直觉引导你的方向。"
                ],
                noon: [
                    "停下来，倾听内心的声音。",
                    "调整能量，保持内在平静。",
                    "准备下午的深度思考。"
                ],
                evening: [
                    "回顾今天的心灵感悟。",
                    "感恩今天的每次领悟。",
                    "带着平静入睡，期待明天的启示。"
                ]
            },
            INFP: {
                morning: [
                    "早安，治愈者！让温柔开启新的一天。",
                    "用善意的心感受这个世界。",
                    "保持理想主义的信念。"
                ],
                noon: [
                    "享受独处的时光。",
                    "让心灵得到休息和滋养。",
                    "准备下午的心灵之旅。"
                ],
                evening: [
                    "感恩今天触动心灵的时刻。",
                    "回顾今天的情感体验。",
                    "带着温暖的心等待明天。"
                ]
            }
        };

        function getRandomQuote(mbtiType) {
            const hour = new Date().getHours();
            let timeOfDay;
            
            if (hour >= 5 && hour < 11) {
                timeOfDay = 'morning';
            } else if (hour >= 11 && hour < 17) {
                timeOfDay = 'noon';
            } else {
                timeOfDay = 'evening';
            }

            const defaultQuotes = {
                morning: [
                    "早安！新的一天充满可能。",
                    "迎接崭新的一天。",
                    "让我们以积极的心态开始今天。"
                ],
                noon: [
                    "中午好！休息一下，继续加油。",
                    "记得给自己一点休息时间。",
                    "补充能量，准备下午的挑战。"
                ],
                evening: [
                    "晚上好！回顾今天的收获。",
                    "感恩今天遇到的每个人和事。",
                    "放松心情，准备迎接明天。"
                ]
            };

            const quotes = motivationalQuotes[mbtiType]?.[timeOfDay] || defaultQuotes[timeOfDay];
            const randomIndex = Math.floor(Math.random() * quotes.length);
            return quotes[randomIndex];
        }

        function showTestSection() {
            currentQuestionIndex = 0;
            answers = new Array(questions.length).fill('');
            showQuestion();
        }

        function showQuoteSection() {
            const container = document.getElementById('main-container');
            const savedMbtiType = localStorage.getItem('mbtiType') || '';
            const quote = getRandomQuote(savedMbtiType);
            const hour = new Date().getHours();
            let timeMessage;
            
            if (hour >= 5 && hour < 11) {
                timeMessage = "早安！开启美好的一天";
            } else if (hour >= 11 && hour < 17) {
                timeMessage = "午好！继续加油";
            } else {
                timeMessage = "晚好！回顾今天的收获";
            }
            
            container.innerHTML = `
                <div class="quote-container">
                    ${savedMbtiType ? `<div class="mbti-type">您的MBTI类型：${savedMbtiType}</div>` : ''}
                    <div class="time-message">${timeMessage}</div>
                    <div class="quote-text">"${quote}"</div>
                    <button class="option-btn" onclick="showNewQuote()">换一条</button>
                    <button class="option-btn" onclick="showHome()">返回首页</button>
                </div>
            `;
        }

        function showNewQuote() {
            const savedMbtiType = localStorage.getItem('mbtiType') || '';
            const quote = getRandomQuote(savedMbtiType);
            const quoteText = document.querySelector('.quote-text');
            quoteText.textContent = `"${quote}"`;
        }

        function showResult() {
            const result = calculateResult();
            localStorage.setItem('mbtiType', result);
            const container = document.getElementById('main-container');
            
            container.innerHTML = `
                <div class="result-container">
                    <h2>测试结果</h2>
                    <p>您的MBTI类型是: ${result}</p>
                    <button class="option-btn" onclick="restartTest()">重新测试</button>
                    <button class="option-btn" onclick="showQuoteSection()">查看今日激励</button>
                </div>
            `;
        }

        function restartTest() {
            currentQuestionIndex = 0;
            answers = new Array(questions.length).fill('');
            showQuestion();
        }

        function showInputSection() {
            const container = document.getElementById('main-container');
            container.innerHTML = `
                <div class="input-section">
                    <h2>请输入您的MBTI类型</h2>
                    <input type="text" id="mbtiInput" placeholder="例如：INTJ" maxlength="4" 
                           oninput="this.value = this.value.toUpperCase()" />
                    <p>请输入4个字母的MBTI类型</p>
                    <button class="action-btn" onclick="saveMBTIType()">确认</button>
                    <button class="option-btn" onclick="showHome()">返回</button>
                </div>
            `;
        }

        function saveMBTIType() {
            const mbtiInput = document.getElementById('mbtiInput').value.toUpperCase();
            const validMBTI = /^[EI][NS][TF][JP]$/;
            
            if (!validMBTI.test(mbtiInput)) {
                alert('请输入有效的MBTI类型！\n第一位：E或I\n第二位：N或S\n第三位：T或F\n第四位：J或P');
                return;
            }

            localStorage.setItem('mbtiType', mbtiInput);
            showQuoteSection();
        }

        function showHome() {
            const container = document.getElementById('main-container');
            container.innerHTML = `
                <div class="action-buttons">
                    <button class="action-btn" onclick="showInputSection()">已知MBTI类型</button>
                    <button class="action-btn" onclick="showTestSection()">开始MBTI测试</button>
                </div>
            `;
        }

        const savedMbtiType = localStorage.getItem('mbtiType');
        if (savedMbtiType) {
            showQuoteSection();
        } else {
            showHome();
        }

        // 聊天相关函数
        function toggleChat() {
            const chatContainer = document.getElementById('chatContainer');
            const isFirstOpen = chatContainer.style.display === 'none' && !chatContainer.dataset.opened;
            chatContainer.style.display = chatContainer.style.display === 'none' ? 'flex' : 'none';
            
            if (isFirstOpen) {
                chatContainer.dataset.opened = 'true';
                const savedMbtiType = localStorage.getItem('mbtiType');
                const welcomeMessage = savedMbtiType 
                    ? `欢迎回来！作为一个 ${savedMbtiType} 类型的人，我很高兴能和你交流。` 
                    : '你好！我是你的AI助手，很高兴见到你。';
                addMessage(welcomeMessage, 'bot');
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (message) {
                addMessage(message, 'user');
                input.value = '';
                
                try {
                    const response = await fetch('http://localhost:3000/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            mbtiType: localStorage.getItem('mbtiType') || '',
                            context: getConversationHistory()
                        })
                    });
                    
                    const data = await response.json();
                    document.getElementById('aiAssistantName').textContent = 
                        `AI 助手 - ${data.aiName}`;
                    addMessage(data.response, 'bot');
                    saveConversation();
                } catch (error) {
                    addMessage('抱歉，出现了一些问题，请稍后再试。', 'bot');
                }
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function addMessage(text, sender, typing = true) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            if (sender === 'bot' && typing) {
                let i = 0;
                messageDiv.textContent = '';
                const interval = setInterval(() => {
                    messageDiv.textContent += text[i];
                    i++;
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    if (i >= text.length) clearInterval(interval);
                }, 30);
            } else {
                messageDiv.textContent = text;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function toggleVoiceInput() {
            if ('webkitSpeechRecognition' in window) {
                const recognition = new webkitSpeechRecognition();
                recognition.lang = 'zh-CN';
                recognition.continuous = false;
                recognition.interimResults = false;

                const voiceButton = document.querySelector('[title="语音输入"]');
                
                recognition.onstart = () => {
                    voiceButton.classList.add('recording');
                };

                recognition.onend = () => {
                    voiceButton.classList.remove('recording');
                };

                recognition.onresult = (event) => {
                    const text = event.results[0][0].transcript;
                    document.getElementById('chatInput').value = text;
                    sendMessage();
                };

                recognition.start();
            } else {
                alert('您的浏览器不支持语音输入功能');
            }
        }

        function uploadFile() {
            document.getElementById('fileInput').click();
        }

        function uploadImage() {
            document.getElementById('imageInput').click();
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const formData = new FormData();
                formData.append('file', file);
                
                addMessage(`正在处理文件: ${file.name}`, 'user');
                try {
                    const response = await fetch('http://localhost:3000/api/upload/file', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    addMessage(data.response, 'bot');
                    saveConversation();
                } catch (error) {
                    addMessage('文件处理失败，请稍后重试。', 'bot');
                }
            }
        }

        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (!file.type.startsWith('image/')) {
                    alert('请选择图片文件');
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message user-message';
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    messageDiv.appendChild(img);
                    document.getElementById('chatMessages').appendChild(messageDiv);

                    try {
                        const formData = new FormData();
                        formData.append('image', file);
                        const response = await fetch('http://localhost:3000/api/upload/image', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();
                        addMessage(data.response, 'bot');
                        saveConversation();
                    } catch (error) {
                        addMessage('图片处理失败，请稍后重试。', 'bot');
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        // 添加对话历史记录相关函数
        function getConversationHistory() {
            const messages = document.querySelectorAll('.message');
            return Array.from(messages).map(msg => ({
                role: msg.classList.contains('user-message') ? 'user' : 'assistant',
                content: msg.textContent
            }));
        }

        function saveConversation() {
            const history = getConversationHistory();
            localStorage.setItem('chatHistory', JSON.stringify(history));
        }

        function loadConversation() {
            const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            history.forEach(msg => {
                addMessage(msg.content, msg.role === 'user' ? 'user' : 'bot', false);
            });
        }

        // 在页面加载时初始化聊天历史
        document.addEventListener('DOMContentLoaded', () => {
            loadConversation();
        });
    </script>
</body>
</html> 